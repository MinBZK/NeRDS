name: Feedback to Issues

on:
  repository_dispatch:
    types: [feedback_submission]

jobs:
  create-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate feedback submission
        id: validate
        run: |
          # Check for required fields
          if [[ -z "${{ github.event.client_payload.feedback_type }}" ]] || \
             [[ -z "${{ github.event.client_payload.feedback_text }}" ]] || \
             [[ -z "${{ github.event.client_payload.user_name }}" ]] || \
             [[ -z "${{ github.event.client_payload.user_email }}" ]]; then
            echo "error=true" >> $GITHUB_OUTPUT
            echo "message=Missing required fields in feedback submission" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "validation_passed=true" >> $GITHUB_OUTPUT

      - name: Check spam/honeypot
        id: spam-check
        run: |
          # Honeypot field check (should be empty)
          WEBSITE="${{ github.event.client_payload.website }}"
          if [[ -n "$WEBSITE" ]]; then
            echo "spam_detected=true" >> $GITHUB_OUTPUT
            echo "Honeypot field detected as filled - likely spam"
            exit 1
          fi
          echo "spam_detected=false" >> $GITHUB_OUTPUT

      - name: Generate reference ID
        id: reference
        run: |
          REF_ID="FB-$(date +%s)-$(openssl rand -hex 5 | tr '[:lower:]' '[:upper:]')"
          echo "reference_id=$REF_ID" >> $GITHUB_OUTPUT

      - name: Map feedback type to label
        id: label
        run: |
          TYPE="${{ github.event.client_payload.feedback_type }}"
          case "$TYPE" in
            bug_report)
              LABEL="bug-report"
              ;;
            feature_request)
              LABEL="feature-request"
              ;;
            general_feedback)
              LABEL="general-feedback"
              ;;
            question)
              LABEL="question"
              ;;
            *)
              LABEL="feedback"
              ;;
          esac
          echo "label=$LABEL" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const feedback = context.payload.client_payload;
            const referenceId = '${{ steps.reference.outputs.reference_id }}';
            const label = '${{ steps.label.outputs.label }}';

            // Sanitize user-provided text to prevent injection
            const sanitizeText = (text) => {
              if (!text) return '';
              return text
                .replace(/[<>]/g, (char) => char === '<' ? '&lt;' : '&gt;')
                .substring(0, 5000);
            };

            const pageUrl = feedback.page_url || 'unknown';
            const pageTitle = feedback.page_title || 'Unknown Page';
            const feedbackType = feedback.feedback_type || 'unknown';
            const feedbackText = sanitizeText(feedback.feedback_text);
            const userName = feedback.user_name || 'Anonymous';
            const userEmail = feedback.user_email || 'no-email@example.com';
            const timestamp = feedback.timestamp || new Date().toISOString();

            // Create issue title
            const title = `[Feedback] ${feedbackType.replace(/_/g, ' ')} - ${pageTitle.substring(0, 60)}`;

            // Create issue body
            const body = `## Page Information
- **URL:** \`${pageUrl}\`
- **Title:** ${pageTitle}
- **Feedback Type:** ${feedbackType.replace(/_/g, ' ')}

## From
- **Name:** ${userName}
- **Email:** ${userEmail}

## Feedback
${feedbackText}

---

**Reference ID:** \`${referenceId}\`
**Submitted:** ${new Date(timestamp).toLocaleString()}
**User Agent:** ${feedback.user_agent || 'unknown'}`;

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: [label, 'feedback'],
            });

            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

            console.log(`✅ Issue created: #${issue.data.number}`);
            console.log(`Reference ID: ${referenceId}`);

      - name: Log feedback submission
        if: success()
        run: |
          echo "✅ Feedback successfully processed"
          echo "Issue #${{ steps.create-issue.outputs.issue_number }}"
          echo "Reference ID: ${{ steps.reference.outputs.reference_id }}"

      - name: Handle validation failure
        if: failure() && steps.validate.outputs.error == 'true'
        run: |
          echo "❌ Feedback validation failed"
          echo "Message: ${{ steps.validate.outputs.message }}"
          exit 1

      - name: Handle spam detection
        if: failure() && steps.spam-check.outputs.spam_detected == 'true'
        run: |
          echo "❌ Spam detected in feedback submission"
          exit 1
